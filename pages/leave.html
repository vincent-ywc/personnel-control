<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<title>健康出入园登记系统</title>
		<link rel="stylesheet" href="../css/weui.min.css">
		<link rel="stylesheet" href="../css/jquery-weui.min.css">
		<style>
			.header {
				height: 46px;
				line-height: 46px;
				background-color: #69c;
				color: #fff;
				text-align: center;
			}
			.content {
				padding: 0 10px;
			}
			.msg-box .weui-cell__hd {
				margin-right: 30px;
			}
			.weui-cells {
				margin-top: 0 !important;
			}
			.weui-label {
				color: #888;
			}
			.msg-box .form-box {
				display: none;
			}
			.weui-cell__ft {
				text-align: right;
			}
			#userIdInput {
				display: none;
			}
			#employee-box, #visitor-box, #tips-error {
				display: none;
			}
			.weui-loading {
				width: 50px;
				height: 50px;
			}
			#loading {
				display: none;
			}
			#tips-error {
				margin-top: 20px;
			}
			.weui-select {
				width: 70% !important;
			}
			.req {
				color: red;
				margin-left: 5px;
				font-weight: bold;
			}
			.search-header {
				display: none;
			}
		</style>
	</head>
	<body>
		<div class="header">
			<div class="title">出园登记</div>
		</div>
		<div class="content">
			<div class="search-header">
				<div class="weui-cells">
				  <div class="weui-cell weui-cell_select">
					<div class="weui-cell__bd">
					  <select class="weui-select" name="select1" id="selectType">
						<option selected="" value="0">请选择人员类型</option>
						<option value="1">我是员工</option>
						<option value="2">我是访客</option>
					  </select>
					</div>
				  </div> 
				</div>
				<div class="weui-cells weui-cells_form" id="userIdInput">
				  <div class="weui-cell">
				    <div class="weui-cell__bd">
					  <input id="cardIdVal" class="weui-input" type="text" required>
				    </div>
					<div class="weui-cell__ft">
					  <button class="weui-vcode-btn" id="get-msg-btn">获取信息</button>
					</div>
				  </div>
				</div>
			</div>
			<div class="msg-box">
				<div class="form-box">
					<div id="employee-box">
						<div class="weui-cell">
							<div class="weui-cell__hd">
							  <label class="weui-label">工号</label>
							</div>
							<div class="weui-cell__bd">
							  <label class="EmployeeId"></label>
							</div>
						</div>
						<div class="weui-cell">
							<div class="weui-cell__hd">
							  <label class="weui-label">姓名</label>
							</div>
							<div class="weui-cell__bd">
							  <label class="EmployeeName"></label>
							</div>
						</div>
						<div class="weui-cell">
							  <div class="weui-cell__hd">
								<label class="weui-label">测量体温<span class="req">* </span> </label>
							  </div>
							<div class="weui-cell__bd">
								<input id="animal-heat-employee" class="weui-input" type="number" pattern="[0-9]." placeholder="请输入测量体温" required>
							</div>
						</div>
						<div class="weui-cell">
							<div class="weui-cell__hd">
							  <label class="weui-label">部门</label>
							</div>
							<div class="weui-cell__bd">
							  <label class="DeptName"></label>
							</div>
						</div>
						<div class="weui-cell">
							<div class="weui-cell__hd">
							  <label class="weui-label">班组</label>
							</div>
							<div class="weui-cell__bd">
							  <label class="GroupName"></label>
							</div>
						</div>
						<div class="weui-cell">
							<div class="weui-cell__hd">
							  <label class="weui-label">入园时间</label>
							</div>
							<div class="weui-cell__bd">
							  <label class="ArriveOfficeDate"></label>
							</div>
						</div>
					</div>
					<div id="visitor-box">
						<div class="weui-cell">
							<div class="weui-cell__hd">
							  <label class="weui-label">姓名</label>
							</div>
							<div class="weui-cell__bd">
							  <label class="EmployeeName"></label>
							</div>
						</div>
						<div class="weui-cell">
							  <div class="weui-cell__hd">
								<label class="weui-label">测量体温<span class="req">* </span> </label>
							  </div>
							<div class="weui-cell__bd">
								<input id="animal-heat-visitor" class="weui-input" type="number" pattern="[0-9]." placeholder="请输入测量体温" required>
							</div>
						</div>
						<div class="weui-cell">
							<div class="weui-cell__hd">
							  <label class="weui-label">手机号</label>
							</div>
							<div class="weui-cell__bd">
							  <label class="EmployeeId"></label>
							</div>
						</div>
						<div class="weui-cell">
							<div class="weui-cell__hd">
							  <label class="weui-label">来访单位</label>
							</div>
							<div class="weui-cell__bd">
							  <label class="VisitingUnit"></label>
							</div>
						</div>
						<div class="weui-cell">
							<div class="weui-cell__hd">
							  <label class="weui-label">来访单位类别</label>
							</div>
							<div class="weui-cell__bd">
							  <label class="DeptName"></label>
							</div>
						</div>
						<div class="weui-cell">
							<div class="weui-cell__hd">
							  <label class="weui-label">入园时间</label>
							</div>
							<div class="weui-cell__bd">
							  <label class="ArriveOfficeDate"></label>
							</div>
						</div>
					</div>
					<div class="weui-btn-area">
					      <a class="weui-btn weui-btn_primary" href="javascript:" id="submit-but">出园</a>
					</div>
				</div>
				<div id="tips-error">
					<p style="text-align: center;color:#888;"></p>
				</div>
			</div>
		</div>
		<div id="loading" class="weui-loadmore">
			<i class="weui-loading"></i>
		</div>
		<script src="../js/zepto.min.js"></script>
		<script src="../js/jquery-weui.min.js"></script>
		<script src="../js/zepto.touch.js"></script>
		<script src="http://g.alicdn.com/dingding/dingtalk-jsapi/2.7.13/dingtalk.open.js"></script>
		<script>
			$(function () {
				var IDFlag = ''
				var typeFlag = ''
				var EmployeeId = ''
				var tapFlag = true
				$('#get-msg-btn').tap(function () {
					if (!$('#cardIdVal').val()) {
						$.toptip('请输入工号/手机号', 'error');
					} else {
						$('#animal-heat-employee').val('')
						$('#animal-heat-visitor').val()
						getPersonnelMsg($('#cardIdVal').val(), $('#selectType').val())
					}
				})
				$('#submit-but').tap(function () {
					if (!$('#animal-heat-employee').val() && !$('#animal-heat-visitor').val()) {
						$.toptip('请填写测量体温', 'error');
					} else {
						if (tapFlag) {
							tapFlag = false
							UpdateUserOutData()
							setTimeout(function () {
								tapFlag = true
							}, 3000)
						}
					}
				})
				
				$('#selectType').change(function () {
					if ($(this).val() == 1) {
						$('#cardIdVal').attr('placeholder', '请输入工号')
						$('#userIdInput').show()
					} else if ($(this).val() == 2) {
						$('#cardIdVal').attr('placeholder', '请输入手机号')
						$('#userIdInput').show()
					} else {
						$('#userIdInput').hide()
					}
				})
				
				function getPersonnelMsg(id, type) {
					typeFlag = type
					$.ajax({
					  url: 'http://106.3.225.253:8087/api/EntrancePermit/QueryUserEnterData',
					  data: {
						 empID: id,
						 type: type
					  },
					  type: 'GET',
					  dataType: 'json',
					  beforeSend: () => {
					    $('#loading').show()
					  },
					  success: (response) => {
					    var result = response.result
						if (result == 1) {
							var info = JSON.parse(response.info)[0]
							IDFlag = info.ID
							EmployeeId = info.EmployeeId
							$('.EmployeeId').html(info.EmployeeId)
							$('.EmployeeName').html(info.EmployeeName)
							$('.DeptName').html(info.DeptName)
							$('.GroupName').html(info.GroupName)
							$('.ArriveOfficeDate').html(info.ArriveOfficeDate.replace(/T/g, ' '))
							$('.Temperature').html(info.Temperature + '℃')
							$('.VisitingUnit').html(info.VisitingUnit)
							if (type == 1) {
								$('#employee-box').show()
								$('#visitor-box').hide()
							} else {
								$('#visitor-box').show()
								$('#employee-box').hide()
							}
							$('.form-box').show()
							$('#tips-error').hide()
						} else {
							$('#tips-error p').html(response.info)
							$('#tips-error').show()
							$('.form-box').hide()
						}
					  },
					  error: (xhr, status) => {
						$.toast("获取数据失败，请稍后重试")
					  },
					  complete: () => {
					    $('#loading').hide()
					  }
					})
				}
				
				// 出园
				function UpdateUserOutData() {
					$.ajax({
					  url: 'http://106.3.225.253:8087/api/EntrancePermit/UpdateUserOutData',
					  data: {
						 ID: IDFlag,
						 type: typeFlag,
						 temp: $('#animal-heat-employee').val() || $('#animal-heat-visitor').val()
					  },
					  type: 'GET',
					  dataType: 'json',
					  success: (response) => {
					    var result = response.result
						if (result == '1') {
							$.toast("提交成功", 1000, function() {
							  location.href = 'leave-result.html?empID=' + EmployeeId + '&type=' + typeFlag
							});
						} else {
							$.toast("提交失败，请稍后重试")
						}
					  },
					  error: (xhr, status) => {
						$.toast("提交失败，请稍后重试")
					  },
					})
				}
				
				// 获取工号
				function getUserId(code) {
					$.ajax({
					  url: 'http://106.3.225.253:8087/api/EntrancePermit/GetUserJobNumber',
					  data: {
						 code: code
					  },
					  type: 'GET',
					  dataType: 'json',
					  success: (response) => {
						  if (response) {
							  getPersonnelMsg(response, 1)								
						  } else {
							 $('.search-header').show() 
						  }
					  },
					  error: (xhr, status) => {
						  $('.search-header').show()
					  },
					})
				}
				
				if (dd.env.platform === 'notInDingTalk') {
					$('.search-header').show()
				} else {
					dd.ready(function () {
					    // dd.ready参数为回调函数，在环境准备就绪时触发，jsapi的调用需要保证在该回调函数触发后调用，否则无效。
					    dd.runtime.permission.requestAuthCode({
					        corpId: "dingdbfb8a312e02f0e835c2f4657eb6378f",
					        onSuccess: function (result) {
								getUserId(result['code'])
					        },
					        onFail: function (err) {
					        }				
					    });
					});
				}
			})
		</script>
	</body>
</html>
